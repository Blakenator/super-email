scalar Date
scalar JSON

interface BaseEntityProps {
  id: String!
  createdAt: Date
  updatedAt: Date
}

# ============ User & Authentication ============

enum ThemePreference {
  LIGHT
  DARK
  AUTO
}

enum NotificationDetailLevel {
  MINIMAL
  FULL
}

type User implements BaseEntityProps {
  id: String!
  createdAt: Date
  updatedAt: Date
  email: String!
  firstName: String!
  lastName: String!
  themePreference: ThemePreference!
  navbarCollapsed: Boolean!
  notificationDetailLevel: NotificationDetailLevel!
  emailAccounts: [EmailAccount!]!
  smtpProfiles: [SmtpProfile!]!
  authenticationMethods: [AuthenticationMethod!]!
}

input UpdateUserPreferencesInput {
  themePreference: ThemePreference
  navbarCollapsed: Boolean
  notificationDetailLevel: NotificationDetailLevel
}

enum AuthProvider {
  EMAIL_PASSWORD
  GOOGLE
  GITHUB
  APPLE
  MICROSOFT
}

type AuthenticationMethod implements BaseEntityProps {
  id: String!
  createdAt: Date
  updatedAt: Date
  userId: String!
  provider: AuthProvider!
  providerUserId: String!
  email: String!
  displayName: String
  lastUsedAt: Date
}


# ============ Email Accounts (IMAP/POP) ============

enum EmailAccountType {
  IMAP
  POP3
}

type EmailAccount implements BaseEntityProps {
  id: String!
  createdAt: Date
  updatedAt: Date
  userId: String!
  name: String!
  email: String!
  host: String!
  port: Int!
  accountType: EmailAccountType!
  useSsl: Boolean!
  lastSyncedAt: Date
  isSyncing: Boolean!
  syncProgress: Int
  syncStatus: String
  defaultSmtpProfileId: String
  defaultSmtpProfile: SmtpProfile
  providerId: String
  isDefault: Boolean!
}

input CreateEmailAccountInput {
  name: String!
  email: String!
  host: String!
  port: Int!
  username: String!
  password: String!
  accountType: EmailAccountType!
  useSsl: Boolean!
  defaultSmtpProfileId: String
  providerId: String
  isDefault: Boolean
}

input UpdateEmailAccountInput {
  id: String!
  name: String
  host: String
  port: Int
  username: String
  password: String
  useSsl: Boolean
  defaultSmtpProfileId: String
  providerId: String
  isDefault: Boolean
}

# ============ SMTP Profiles ============

type SmtpProfile implements BaseEntityProps {
  id: String!
  createdAt: Date
  updatedAt: Date
  userId: String!
  name: String!
  email: String!
  alias: String
  host: String!
  port: Int!
  useSsl: Boolean!
  isDefault: Boolean!
  providerId: String
}

input CreateSmtpProfileInput {
  name: String!
  email: String!
  alias: String
  host: String!
  port: Int!
  username: String!
  password: String!
  useSsl: Boolean!
  isDefault: Boolean
  providerId: String
}

input UpdateSmtpProfileInput {
  id: String!
  name: String
  alias: String
  host: String
  port: Int
  username: String
  password: String
  useSsl: Boolean
  isDefault: Boolean
  providerId: String
}

# ============ Contacts ============

type ContactEmail implements BaseEntityProps {
  id: String!
  createdAt: Date
  updatedAt: Date
  contactId: String!
  email: String!
  isPrimary: Boolean!
  label: String
}

type Contact implements BaseEntityProps {
  id: String!
  createdAt: Date
  updatedAt: Date
  userId: String!
  email: String
  emails: [ContactEmail!]!
  name: String
  firstName: String
  lastName: String
  company: String
  phone: String
  notes: String
  isAutoCreated: Boolean!
}

input ContactEmailInput {
  email: String!
  isPrimary: Boolean
  label: String
}

input CreateContactInput {
  emails: [ContactEmailInput!]!
  name: String
  firstName: String
  lastName: String
  company: String
  phone: String
  notes: String
}

input UpdateContactInput {
  id: String!
  emails: [ContactEmailInput!]
  name: String
  firstName: String
  lastName: String
  company: String
  phone: String
  notes: String
}

input AddEmailToContactInput {
  contactId: String!
  email: String!
  isPrimary: Boolean
  label: String
}

# ============ Emails ============

enum EmailFolder {
  INBOX
  SENT
  DRAFTS
  TRASH
  SPAM
  ARCHIVE
}

type Email implements BaseEntityProps {
  id: String!
  createdAt: Date
  updatedAt: Date
  emailAccountId: String!
  emailAccount: EmailAccount
  smtpProfileId: String
  smtpProfile: SmtpProfile
  messageId: String!
  folder: EmailFolder!
  fromAddress: String!
  fromName: String
  toAddresses: [String!]!
  ccAddresses: [String!]
  bccAddresses: [String!]
  subject: String!
  textBody: String
  htmlBody: String
  receivedAt: Date!
  isRead: Boolean!
  isStarred: Boolean!
  isDraft: Boolean!
  inReplyTo: String
  references: [String!]
  threadId: String
  threadCount: Int
  headers: JSON
  isUnsubscribed: Boolean!
  unsubscribeUrl: String
  unsubscribeEmail: String
  tags: [Tag!]!
}

# ============ Tags ============

type Tag implements BaseEntityProps {
  id: String!
  createdAt: Date
  updatedAt: Date
  userId: String!
  name: String!
  color: String!
  description: String
  emailCount: Int!
}

input CreateTagInput {
  name: String!
  color: String
  description: String
}

input UpdateTagInput {
  id: String!
  name: String
  color: String
  description: String
}

input AddTagsToEmailsInput {
  emailIds: [String!]!
  tagIds: [String!]!
}

input RemoveTagsFromEmailsInput {
  emailIds: [String!]!
  tagIds: [String!]!
}

# ============ Mail Rules ============

type RuleConditions {
  fromContains: String
  toContains: String
  ccContains: String
  bccContains: String
  subjectContains: String
  bodyContains: String
}

type RuleActions {
  archive: Boolean
  star: Boolean
  delete: Boolean
  markRead: Boolean
  addTagIds: [String!]
  forwardTo: String
}

type MailRule implements BaseEntityProps {
  id: String!
  createdAt: Date
  updatedAt: Date
  userId: String!
  emailAccountId: String
  emailAccount: EmailAccount
  name: String!
  description: String
  conditions: RuleConditions!
  actions: RuleActions!
  isEnabled: Boolean!
  priority: Int!
  stopProcessing: Boolean!
}

input RuleConditionsInput {
  fromContains: String
  toContains: String
  ccContains: String
  bccContains: String
  subjectContains: String
  bodyContains: String
}

input RuleActionsInput {
  archive: Boolean
  star: Boolean
  delete: Boolean
  markRead: Boolean
  addTagIds: [String!]
  forwardTo: String
}

input CreateMailRuleInput {
  emailAccountId: String
  name: String!
  description: String
  conditions: RuleConditionsInput!
  actions: RuleActionsInput!
  isEnabled: Boolean
  priority: Int
  stopProcessing: Boolean
}

input UpdateMailRuleInput {
  id: String!
  emailAccountId: String
  name: String
  description: String
  conditions: RuleConditionsInput
  actions: RuleActionsInput
  isEnabled: Boolean
  priority: Int
  stopProcessing: Boolean
}

type RunRuleResult {
  matchedCount: Int!
  processedCount: Int!
}

input GetEmailsInput {
  emailAccountId: String
  folder: EmailFolder
  limit: Int
  offset: Int
  isRead: Boolean
  isStarred: Boolean
  searchQuery: String
  # Advanced filters
  fromContains: String
  toContains: String
  ccContains: String
  bccContains: String
  subjectContains: String
  bodyContains: String
  tagIds: [String!]
}

input GetEmailInput {
  id: String!
}

input ComposeEmailInput {
  emailAccountId: String!
  smtpProfileId: String!
  toAddresses: [String!]!
  ccAddresses: [String!]
  bccAddresses: [String!]
  subject: String!
  textBody: String
  htmlBody: String
  inReplyTo: String
  draftId: String
}

input SaveDraftInput {
  id: String
  emailAccountId: String!
  smtpProfileId: String
  toAddresses: [String!]
  ccAddresses: [String!]
  bccAddresses: [String!]
  subject: String
  textBody: String
  htmlBody: String
  inReplyTo: String
}

input BulkUpdateEmailsInput {
  ids: [String!]!
  isRead: Boolean
  isStarred: Boolean
  folder: EmailFolder
}

input ForwardEmailInput {
  emailId: String!
  emailAccountId: String!
  smtpProfileId: String!
  toAddresses: [String!]!
  ccAddresses: [String!]
  bccAddresses: [String!]
  additionalText: String
}

input SyncEmailAccountInput {
  emailAccountId: String!
}

input UnsubscribeInput {
  emailId: String!
}

# ============ Test Connection ============

type TestConnectionResult {
  success: Boolean!
  message: String!
}

input TestEmailAccountConnectionInput {
  host: String!
  port: Int!
  username: String!
  password: String!
  accountType: EmailAccountType!
  useSsl: Boolean!
}

input TestSmtpConnectionInput {
  host: String!
  port: Int!
  username: String!
  password: String!
  useSsl: Boolean!
}

# ============ Queries ============

type Query {
  # Auth
  fetchProfile: User
  getAuthenticationMethods: [AuthenticationMethod!]!

  # Email Accounts
  getEmailAccounts: [EmailAccount!]!
  getEmailAccount(id: String!): EmailAccount

  # SMTP Profiles
  getSmtpProfiles: [SmtpProfile!]!
  getSmtpProfile(id: String!): SmtpProfile

  # Emails
  getEmails(input: GetEmailsInput!): [Email!]!
  getEmail(input: GetEmailInput!): Email
  getEmailCount(input: GetEmailsInput!): Int!
  getEmailsByThread(threadId: String!): [Email!]!

  # Contacts
  getContacts: [Contact!]!
  getContact(id: String!): Contact
  searchContacts(query: String!): [Contact!]!

  # Tags
  getTags: [Tag!]!
  getTag(id: String!): Tag

  # Mail Rules
  getMailRules: [MailRule!]!
  getMailRule(id: String!): MailRule
  previewMailRule(id: String!): Int!
}

# ============ Mutations ============

type Mutation {
  # Auth
  deleteAuthenticationMethod(id: String!): Boolean!
  updateThemePreference(themePreference: ThemePreference!): User!
  updateUserPreferences(input: UpdateUserPreferencesInput!): User!

  # Email Accounts
  createEmailAccount(input: CreateEmailAccountInput!): EmailAccount!
  updateEmailAccount(input: UpdateEmailAccountInput!): EmailAccount!
  deleteEmailAccount(id: String!): Boolean!
  syncEmailAccount(input: SyncEmailAccountInput!): Boolean!

  # SMTP Profiles
  createSmtpProfile(input: CreateSmtpProfileInput!): SmtpProfile!
  updateSmtpProfile(input: UpdateSmtpProfileInput!): SmtpProfile!
  deleteSmtpProfile(id: String!): Boolean!

  # Test Connections
  testEmailAccountConnection(input: TestEmailAccountConnectionInput!): TestConnectionResult!
  testSmtpConnection(input: TestSmtpConnectionInput!): TestConnectionResult!

  # Emails
  sendEmail(input: ComposeEmailInput!): Email!
  saveDraft(input: SaveDraftInput!): Email!
  bulkUpdateEmails(input: BulkUpdateEmailsInput!): [Email!]!
  bulkDeleteEmails(ids: [String!]!): Int!
  forwardEmail(input: ForwardEmailInput!): Email!
  unsubscribe(input: UnsubscribeInput!): Email!

  # Contacts
  createContact(input: CreateContactInput!): Contact!
  updateContact(input: UpdateContactInput!): Contact!
  deleteContact(id: String!): Boolean!
  createContactFromEmail(emailId: String!): Contact!
  addEmailToContact(input: AddEmailToContactInput!): Contact!

  # Sync
  syncAllAccounts: Boolean!

  # Inbox Zero
  nukeOldEmails(input: NukeOldEmailsInput!): Int!

  # Tags
  createTag(input: CreateTagInput!): Tag!
  updateTag(input: UpdateTagInput!): Tag!
  deleteTag(id: String!): Boolean!
  addTagsToEmails(input: AddTagsToEmailsInput!): [Email!]!
  removeTagsFromEmails(input: RemoveTagsFromEmailsInput!): [Email!]!

  # Mail Rules
  createMailRule(input: CreateMailRuleInput!): MailRule!
  updateMailRule(input: UpdateMailRuleInput!): MailRule!
  deleteMailRule(id: String!): Boolean!
  runMailRule(id: String!): RunRuleResult!
}

input NukeOldEmailsInput {
  olderThan: Date!
}

# ============ Subscriptions ============

type MailboxUpdate {
  type: MailboxUpdateType!
  emailAccountId: String!
  emails: [Email!]
  message: String
}

enum MailboxUpdateType {
  NEW_EMAILS
  EMAIL_UPDATED
  EMAIL_DELETED
  SYNC_STARTED
  SYNC_COMPLETED
  CONNECTION_ESTABLISHED
  CONNECTION_CLOSED
  ERROR
}

type Subscription {
  # Subscribe to mailbox updates for all user's email accounts
  # The connection will use IMAP IDLE to listen for new emails
  # Connection expires after 4.5 minutes - client should reconnect
  mailboxUpdates: MailboxUpdate!
}
